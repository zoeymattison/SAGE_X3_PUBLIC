With StockData AS (
    SELECT
        STO.ITMREF_0,
		SUM(CASE WHEN STO.STOFCY_0 = '1200' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_1200,
		SUM(CASE WHEN STO.STOFCY_0 = '1600' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_1600,
		SUM(CASE WHEN STO.STOFCY_0 = '1700' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_1700,
		SUM(CASE WHEN STO.STOFCY_0 = '1800' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_1800,
		SUM(CASE WHEN STO.STOFCY_0 = '2100' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_2100,
		SUM(CASE WHEN STO.STOFCY_0 = '2200' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_2200,
		SUM(CASE WHEN STO.STOFCY_0 = '2300' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_2300,
		SUM(CASE WHEN STO.STOFCY_0 = '2400' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_2400,
		SUM(CASE WHEN STO.STOFCY_0 = '2500' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_2500,
		SUM(CASE WHEN STO.STOFCY_0 = '2600' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_2600,
		SUM(CASE WHEN STO.STOFCY_0 = '2700' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_2700,
		SUM(CASE WHEN STO.STOFCY_0 = '2800' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_2800,
		SUM(CASE WHEN STO.STOFCY_0 = '3200' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_3200,
		SUM(CASE WHEN STO.STOFCY_0 = 'CR53' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CR53,
		SUM(CASE WHEN STO.STOFCY_0 = 'CR54' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CR54,
		SUM(CASE WHEN STO.STOFCY_0 = 'CR55' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CR55,
		SUM(CASE WHEN STO.STOFCY_0 = 'CR56' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CR56,
		SUM(CASE WHEN STO.STOFCY_0 = 'CR57' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CR57,
		SUM(CASE WHEN STO.STOFCY_0 = 'CR58' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CR58,
		SUM(CASE WHEN STO.STOFCY_0 = 'CR59' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CR59,
		SUM(CASE WHEN STO.STOFCY_0 = 'CR60' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CR60,
		SUM(CASE WHEN STO.STOFCY_0 = 'CR61' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CR61,
		SUM(CASE WHEN STO.STOFCY_0 = 'CR62' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CR62,
		SUM(CASE WHEN STO.STOFCY_0 = 'CR63' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CR63,
		SUM(CASE WHEN STO.STOFCY_0 = 'CRMA' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CRMA,
		SUM(CASE WHEN STO.STOFCY_0 = 'CRST' THEN STO.QTYSTU_0 ELSE 0 END) AS STK_CRST
    FROM STOCK STO
    GROUP BY STO.ITMREF_0
),
SalesData AS (
    SELECT
        SID.ITMREF_0,
		SUM(CASE WHEN SID.CREDAT_0 >= dateadd(day,-30,GETDATE()) THEN SID.QTYSTU_0*SIH.SNS_0 ELSE 0 END) AS QTY_30D,
		SUM(CASE WHEN SID.CREDAT_0 >= dateadd(day,-90,GETDATE()) THEN SID.QTYSTU_0*SIH.SNS_0 ELSE 0 END) AS QTY_90D,
		SUM(CASE WHEN SID.CREDAT_0 >= dateadd(year,-1,GETDATE()) THEN SID.QTYSTU_0*SIH.SNS_0 ELSE 0 END) AS QTY_365D,
		SUM(CASE WHEN SID.CREDAT_0 >= dateadd(year,-1,GETDATE()) THEN SID.AMTNOTLIN_0*SIH.SNS_0 ELSE 0 END) AS SALES_365D

    FROM SINVOICED SID
	LEFT JOIN SINVOICE SIH ON SID.NUM_0=SIH.NUM_0
	GROUP BY ITMREF_0
),
VendorInfo AS (
    SELECT
        ITMREF_0,
        ITP.BPSNUM_0,
	BPS.BPSNAM_0,
        ROW_NUMBER() OVER (PARTITION BY ITMREF_0 ORDER BY CASE WHEN PIO_0 = 0 THEN 0 ELSE 1 END, PIO_0) AS VendorRank
    FROM ITMBPS ITP
    LEFT JOIN BPSUPPLIER BPS ON BPS.BPSNUM_0 = ITP.BPSNUM_0
),
VendorQty AS (
	SELECT
		ITMREF_0,
		SUM(QTYSTU_0-RCPQTYSTU_0) AS POHQTY
	FROM
		PORDERQ
	WHERE
		LINCLEFLG_0=1
	AND LEFT(BPSNUM_0,1)='V'
	GROUP BY
		ITMREF_0
)


SELECT
ITM.ITMREF_0,
STK_1200,
STK_1600,
STK_1700,
STK_1800,
STK_2100,
STK_2200,
STK_2300,
STK_2400,
STK_2500,
STK_2600,
STK_2700,
STK_2800,
STK_3200,
STK_CR53,
STK_CR54,
STK_CR55,
STK_CR56,
STK_CR57,
STK_CR58,
STK_CR59,
STK_CR60,
STK_CR61,
STK_CR62,
STK_CR63,
STK_CRMA,
STK_CRST,
SAL.QTY_30D,
SAL.QTY_90D,
SAL.QTY_365D,
SAL.SALES_365D,
MAX(CASE WHEN VI.VendorRank = 1 THEN VI.BPSNUM_0 ELSE 'N/A' END) AS PrimaryVendor,
MAX(CASE WHEN VI.VendorRank = 2 THEN VI.BPSNUM_0 ELSE 'N/A' END) AS SecondaryVendor,
VQ.POHQTY


FROM ITMMASTER ITM
LEFT JOIN StockData STK ON ITM.ITMREF_0=STK.ITMREF_0
LEFT JOIN SalesData SAL ON ITM.ITMREF_0=SAL.ITMREF_0
LEFT JOIN VendorInfo VI ON ITM.ITMREF_0 = VI.ITMREF_0
LEFT JOIN VendorQty VQ ON ITM.ITMREF_0=VQ.ITMREF_0

GROUP BY
ITM.ITMREF_0,
STK_1200,
STK_1600,
STK_1700,
STK_1800,
STK_2100,
STK_2200,
STK_2300,
STK_2400,
STK_2500,
STK_2600,
STK_2700,
STK_2800,
STK_3200,
STK_CR53,
STK_CR54,
STK_CR55,
STK_CR56,
STK_CR57,
STK_CR58,
STK_CR59,
STK_CR60,
STK_CR61,
STK_CR62,
STK_CR63,
STK_CRMA,
STK_CRST,
SAL.QTY_30D,
SAL.QTY_90D,
SAL.QTY_365D,
SAL.SALES_365D,
VQ.POHQTY